name: AnnotationSync Plugin Tests

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

defaults:
  run:
    shell: bash

jobs:
  test:
    name: "Run AnnotationSync Integration Tests"
    runs-on: ubuntu-latest
    container:
      image: koreader/kobase:0.5.3-22.04

    env:
      KODEBUG: "1"
      MAKEFLAGS: OUTPUT_DIR=build PARALLEL_JOBS=4 INSTALL_DIR=install
      EMULATE_READER: "1"

    steps:
      - name: Checkout KOReader Core
        uses: actions/checkout@v4
        with:
          repository: koreader/koreader
          path: koreader_core
          fetch-depth: 0

      - name: Checkout AnnotationSync Plugin
        uses: actions/checkout@v4
        with:
          path: koreader_core/plugins/AnnotationSync.koplugin

      - name: Generate Cache Key
        run: |
          cd koreader_core
          make TARGET= cache-key

      - name: Cache Thirdparty
        uses: actions/cache@v4
        with:
          path: koreader_core/base/thirdparty
          key: ${{ runner.os }}-thirdparty-${{ hashFiles('koreader_core/cache-key') }}
          restore-keys: |
            ${{ runner.os }}-thirdparty-

      - name: Cache Build Directory
        uses: actions/cache@v4
        with:
          path: koreader_core/build
          key: ${{ runner.os }}-build-${{ hashFiles('koreader_core/cache-key') }}
          restore-keys: |
            ${{ runner.os }}-build-

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.cache/ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('koreader_core/cache-key') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Fetch Thirdparty
        run: |
          cd koreader_core
          git config --global --add safe.directory /__w/AnnotationSync/AnnotationSync/koreader_core
          make fetchthirdparty

      - name: Build Base (Needed for tests)
        run: |
          cd koreader_core
          # Use --assume-old=base if we have a cached build to avoid unnecessary rebuilds
          if [ -d build ]; then
            make base --assume-old=base
          else
            make base
          fi

      - name: Run AnnotationSync Tests
        run: |
          cd koreader_core/plugins/AnnotationSync.koplugin
          ./run_tests.sh ../..
